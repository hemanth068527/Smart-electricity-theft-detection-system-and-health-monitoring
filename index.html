<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Electricity Theft & Transformer Health Monitoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
      color: #ffffff;
      margin: 0;
      padding: 20px;
    }

    h1, h2 {
      text-align: center;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .card {
      background: #ffffff;
      color: #333;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }

    .value {
      font-size: 32px;
      font-weight: bold;
      margin-top: 10px;
    }

    .unit {
      font-size: 14px;
      color: #777;
    }

    .status {
      margin-top: 30px;
      padding: 20px;
      text-align: center;
      font-size: 26px;
      font-weight: bold;
      border-radius: 15px;
    }

    .normal { background: #2ecc71; }
    .theft  { background: #e74c3c; }

    .health-good { background:#27ae60;color:white;padding:8px;border-radius:10px; }
    .health-warn { background:#f39c12;color:white;padding:8px;border-radius:10px; }
    .health-bad  { background:#c0392b;color:white;padding:8px;border-radius:10px; }

    iframe {
      width: 100%;
      height: 260px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    #theftTime {
      margin-top: 15px;
      font-size: 18px;
      display: none;
      text-align: center;
    }

    .footer {
      margin-top: 40px;
      text-align: center;
      font-size: 14px;
      opacity: 0.8;
    }
  </style>
</head>

<body>

<h1>‚ö° Smart Electricity Theft Monitoring</h1>
<p style="text-align:center;">Live ESP32 Data via ThingSpeak Cloud</p>

<!-- ===== LIVE VALUES ===== -->
<div class="grid">

  <div class="card">
    <h3>üîå Transformer Current</h3>
    <div class="value" id="transformer">--</div>
    <div class="unit">Amps</div>
  </div>

  <div class="card">
    <h3>ü©∫ Transformer Health</h3>
    <div class="value" id="health">--</div>
    <div class="unit">Load Based</div>
  </div>

  <div class="card">
    <h3>üè† House 1 Current</h3>
    <div class="value" id="house1">--</div>
    <div class="unit">Amps</div>
  </div>

  <div class="card">
    <h3>üè† House 2 Current</h3>
    <div class="value" id="house2">--</div>
    <div class="unit">Amps</div>
  </div>

  <div class="card">
    <h3>‚ö† Unmetered Current</h3>
    <div class="value" id="diff">--</div>
    <div class="unit">Amps</div>
  </div>

</div>

<!-- ===== STATUS & TIME ===== -->
<div id="statusBox" class="status">STATUS</div>
<div id="theftTime"></div>

<!-- ===== GRAPHS ===== -->
<h2>üìä Live Power Analytics</h2>

<div class="grid">
  <div class="card">
    <h3>Transformer Current</h3>
    <iframe src="https://thingspeak.com/channels/3236533/charts/1?dynamic=true&results=60"></iframe>
  </div>
  <div class="card">
    <h3>House 1 Current</h3>
    <iframe src="https://thingspeak.com/channels/3236533/charts/2?dynamic=true&results=60"></iframe>
  </div>
  <div class="card">
    <h3>House 2 Current</h3>
    <iframe src="https://thingspeak.com/channels/3236533/charts/3?dynamic=true&results=60"></iframe>
  </div>
  <div class="card">
    <h3>Unmetered Current</h3>
    <iframe src="https://thingspeak.com/channels/3236533/charts/4?dynamic=true&results=60"></iframe>
  </div>
</div>

<div class="footer">
  ESP32 | ACS712 | ZMCT103C | ThingSpeak
</div>

<script>
  const CHANNEL_ID = "3236533";
  const READ_API_KEY = "X9QA1LSCASFB7N60";

  const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=1&api_key=${READ_API_KEY}`;

  function formatTime(ts) {
    return new Date(ts).toLocaleString();
  }

  async function fetchData() {
    try {
      const res = await fetch(url);
      const json = await res.json();
      const data = json.feeds[0];

      const tr = parseFloat(data.field1);
      const h1 = parseFloat(data.field2);
      const h2 = parseFloat(data.field3);
      const diff = parseFloat(data.field4);
      const theft = data.field5;
      const time = data.created_at;

      document.getElementById("transformer").innerText = tr.toFixed(2);
      document.getElementById("house1").innerText = h1.toFixed(2);
      document.getElementById("house2").innerText = h2.toFixed(2);
      document.getElementById("diff").innerText = diff.toFixed(2);

      const health = document.getElementById("health");
      health.className = "value";
      if (tr < 5) {
        health.innerText = "GOOD";
        health.classList.add("health-good");
      } else if (tr < 8) {
        health.innerText = "CHECK";
        health.classList.add("health-warn");
      } else {
        health.innerText = "DANGER";
        health.classList.add("health-bad");
      }

      const statusBox = document.getElementById("statusBox");
      const theftTime = document.getElementById("theftTime");

      if (theft === "1") {
        statusBox.innerText = "üö® ELECTRICITY THEFT DETECTED";
        statusBox.className = "status theft";
        theftTime.style.display = "block";
        theftTime.innerHTML =
          "üïí Theft Detected At: <b>" + formatTime(time) + "</b>";
      } else {
        statusBox.innerText = "‚úÖ NORMAL OPERATION";
        statusBox.className = "status normal";
        theftTime.style.display = "none";
      }

    } catch (err) {
      console.error("ThingSpeak Error:", err);
    }
  }

  fetchData();
  setInterval(fetchData, 15000);
</script>

</body>
</html>
